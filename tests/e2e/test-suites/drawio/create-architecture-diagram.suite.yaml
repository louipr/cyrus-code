# Create Architecture Diagram Smoke Test
#
# Opens Draw.io and creates a simple 3-tier UML architecture diagram.
#
# @agent-context
# Context for LLM agents and developers working with Draw.io test suites.
#
# Access: '[data-testid="diagram-webview"]' via webview.executeJavaScript()
#
# Globals available in Draw.io context:
#   __cyrusEditorUi  - EditorUi instance captured by preload hook (drawio-preload.ts)
#   __cyrusHooked    - Boolean indicating hook was installed
#   editorUi         - Native Draw.io EditorUi (embed mode only)
#   App              - Draw.io application class
#
# Key selectors:
#   .geDiagramContainer  - Main diagram container
#   .geDialog            - Draw.io dialog boxes
#   .geMenubar           - Menu bar
#   .geItem              - Menu items
#   .mxPopupMenu         - Context menus
#
# Hook mechanism (see electron/preload/drawio-preload.ts):
#   The preload script wraps App.main() to intercept the EditorUi callback.
#   This provides access to:
#   - editorUi.editor.graph      - the mxGraph instance
#   - editorUi.editor.exportToCanvas() - native PNG export
#   - editorUi.actions           - menu action handlers

description: Open Draw.io and create a 3-tier architecture diagram with Frontend, API, and Database components.

metadata:
  status: draft
  reliability: medium
  tags: [smoke, diagram, drawio, uml]
  author: smoke-test
  created: "2025-01-03"
  modified: "2025-01-04"

context:
  app: cyrus-code
  prerequisites:
    - App is launched
  waitFor: "[data-testid='search-bar']"

test_cases:
  - id: open_diagram
    description: Open diagram view
    steps:
      - action: click
        selector: "[data-testid='view-toggle'] button:has-text('Diagram')"
        why: Click the Diagram button to switch to diagram view.

      - action: wait-for
        selector: "[data-testid='diagram-webview']"
        timeout: 10000
        why: Wait for Draw.io webview to appear.

  - id: wait_for_drawio
    description: Wait for Draw.io editor
    depends: [open_diagram]
    steps:
      - action: evaluate
        code: |
          // Wait for Draw.io to fully initialize inside the webview
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) throw new Error('Webview not found');

          // Poll for Draw.io readiness
          for (let i = 0; i < 30; i++) {
            await new Promise(r => setTimeout(r, 500));
            try {
              const ready = await webview.executeJavaScript(`
                (function() {
                  const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
                  return !!(ui && ui.editor && ui.editor.graph);
                })()
              `);
              if (ready) {
                return { ready: true, attempts: i + 1 };
              }
            } catch (e) {
              // Continue polling
            }
          }
          throw new Error('Draw.io editor not ready after 15 seconds');
        timeout: 20000
        why: Wait for Draw.io's editor API to be available.

  - id: wait_for_editor_ready
    description: Wait for editor to be fully ready
    depends: [wait_for_drawio]
    steps:
      - action: evaluate
        code: |
          // Wait for the loading indicator to disappear
          for (let i = 0; i < 50; i++) {
            await new Promise(r => setTimeout(r, 200));
            const loading = document.querySelector('[data-testid="diagram-loading"]');
            if (!loading) {
              return { ready: true, attempts: i + 1 };
            }
          }
          throw new Error('Editor loading indicator did not disappear after 10 seconds');
        timeout: 15000
        why: |
          The React component sets isReady=true when it receives the IPC 'ready' message.
          Wait for the loading indicator to disappear.

  - id: create_diagram
    description: Create 3-tier architecture diagram
    depends: [wait_for_editor_ready]
    steps:
      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) throw new Error('Webview not found');

          // Create a 3-tier architecture diagram using Draw.io's API
          const result = await webview.executeJavaScript(`
            (function() {
              const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
              if (!ui || !ui.editor || !ui.editor.graph) {
                return { error: 'Editor not ready' };
              }

              const graph = ui.editor.graph;
              const model = graph.getModel();
              const parent = graph.getDefaultParent();

              model.beginUpdate();
              try {
                // Clear existing content
                graph.removeCells(graph.getChildCells(parent, true, true));

                // Component style (UML component box)
                const componentStyle = 'rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;fontSize=14;';
                const dbStyle = 'shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;fontSize=14;';
                const arrowStyle = 'edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#666666;';

                // Create Frontend component
                const frontend = graph.insertVertex(parent, null, 'Frontend\\n(React)', 200, 50, 140, 70, componentStyle);

                // Create API component
                const api = graph.insertVertex(parent, null, 'API\\n(Express)', 200, 180, 140, 70, componentStyle);

                // Create Database component
                const database = graph.insertVertex(parent, null, 'Database\\n(PostgreSQL)', 200, 310, 140, 80, dbStyle);

                // Create connections
                graph.insertEdge(parent, null, 'HTTP/REST', frontend, api, arrowStyle);
                graph.insertEdge(parent, null, 'SQL', api, database, arrowStyle);

                // Fit the diagram in view
                graph.fit();
                graph.center();

                return {
                  success: true,
                  components: 3,
                  connections: 2,
                  message: '3-tier architecture diagram created'
                };
              } finally {
                model.endUpdate();
              }
            })()
          `);

          if (result.error) throw new Error(result.error);
          return result;
        timeout: 10000
        returns: "{ success: true, components: 3, connections: 2 }"
        why: Use Draw.io's graph API to create a 3-tier architecture with Frontend, API, and Database components.

  - id: verify_diagram
    description: Verify diagram was created
    depends: [create_diagram]
    steps:
      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) throw new Error('Webview not found');

          const result = await webview.executeJavaScript(`
            (function() {
              const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
              if (!ui || !ui.editor || !ui.editor.graph) {
                return { error: 'Editor not ready' };
              }

              const graph = ui.editor.graph;
              const parent = graph.getDefaultParent();
              const cells = graph.getChildCells(parent, true, true);

              // Count vertices (components) and edges (connections)
              let vertices = 0;
              let edges = 0;
              for (const cell of cells) {
                if (cell.vertex) vertices++;
                if (cell.edge) edges++;
              }

              return {
                verified: vertices >= 3 && edges >= 2,
                vertices: vertices,
                edges: edges
              };
            })()
          `);

          if (!result.verified) {
            throw new Error('Diagram verification failed: expected at least 3 vertices and 2 edges, got ' + result.vertices + ' vertices and ' + result.edges + ' edges');
          }
          return result;
        timeout: 5000
        returns: "{ verified: true, vertices: 3, edges: 2 }"
        why: Verify the diagram contains the expected components and connections.

# Usage example in tests:
#
# const player = new RecordingPlayer(webContents, recording);
# const result = await player.play();
#
# expect(result.success).toBe(true);
# // Diagram now contains 3 components and 2 connections
