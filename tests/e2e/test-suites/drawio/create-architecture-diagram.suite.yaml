# Create Architecture Diagram Smoke Test
#
# Opens Draw.io and creates a simple 3-tier UML architecture diagram.
#
# @agent-context
# Context for LLM agents and developers working with Draw.io test suites.
#
# Access: '[data-testid="diagram-webview"]' via webview.executeJavaScript()
#
# Globals available in Draw.io context:
#   editorUi         - Native Draw.io EditorUi instance
#   App              - Draw.io application class
#
# Key selectors:
#   .geDiagramContainer  - Main diagram container
#   .geDialog            - Draw.io dialog boxes
#   .geMenubar           - Menu bar
#   .geItem              - Menu items
#   .mxPopupMenu         - Context menus
#
# Access pattern (see electron/drawio-preload.ts):
#   The preload script accesses Draw.io's native window.editorUi instance.
#   This provides access to:
#   - editorUi.editor.graph      - the mxGraph instance
#   - editorUi.editor.exportToCanvas() - native PNG export
#   - editorUi.actions           - menu action handlers

description: |
  Create a 3-tier architecture diagram and export to PNG via Draw.io GUI.
  Tests the full export UI flow (dialogs, buttons) up to the native OS save dialog,
  then programmatically writes the file to bypass the OS dialog.
  Outputs: /tmp/architecture-diagram.png

metadata:
  status: verified
  reliability: high
  tags: [diagram, drawio, export, png]
  author: smoke-test
  created: "2025-01-03"
  modified: "2025-01-14"

context:
  app: cyrus-code
  prerequisites:
    - App is launched

test_cases:
  - id: open_diagram
    description: Open diagram view
    steps:
      - action: wait
        timeout: 1000
        expect:
          type: selector
          selector: "[data-testid='view-toggle']"
        why: Wait for app to be ready.

      - action: click
        selector: "[data-testid='view-toggle'] button:has-text('Diagram')"
        why: Click the Diagram button to switch to diagram view.

      - action: wait
        timeout: 1000
        expect:
          type: selector
          selector: "[data-testid='diagram-webview']"
        why: Wait for Draw.io webview to appear.

  - id: wait_for_drawio
    description: Wait for Draw.io editor
    depends: [open_diagram]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (async function() {
            const timeout = 20000;
            const interval = 500;
            const start = Date.now();
            while (Date.now() - start < timeout) {
              const ui = window.editorUi;
              if (ui && ui.editor && ui.editor.graph) {
                return { ready: true };
              }
              await new Promise(r => setTimeout(r, interval));
            }
            throw new Error('Draw.io editor not ready within timeout');
          })()
        timeout: 1000
        why: Wait for Draw.io's editor API to be available.

  - id: wait_for_editor_ready
    description: Wait for editor loading indicator to disappear
    depends: [wait_for_drawio]
    steps:
      - action: wait
        timeout: 1000
        expect:
          type: selector
          selector: "[data-testid='diagram-loading']"
          exists: false
        why: Verify the React loading indicator has disappeared.

  - id: create_diagram
    description: Create 3-tier architecture diagram
    depends: [wait_for_editor_ready]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (function() {
            const ui = window.editorUi;
            if (!ui || !ui.editor || !ui.editor.graph) {
              return { error: 'Editor not ready' };
            }

            const graph = ui.editor.graph;
            const model = graph.getModel();
            const parent = graph.getDefaultParent();

            model.beginUpdate();
            try {
              graph.removeCells(graph.getChildCells(parent, true, true));

              const componentStyle = 'rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;fontSize=14;';
              const dbStyle = 'shape=cylinder3;whiteSpace=wrap;html=1;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#f8cecc;strokeColor=#b85450;fontStyle=1;fontSize=14;';
              const arrowStyle = 'edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#666666;';

              const frontend = graph.insertVertex(parent, null, 'Frontend\\n(React)', 200, 50, 140, 70, componentStyle);
              const api = graph.insertVertex(parent, null, 'API\\n(Express)', 200, 180, 140, 70, componentStyle);
              const database = graph.insertVertex(parent, null, 'Database\\n(PostgreSQL)', 200, 310, 140, 80, dbStyle);

              graph.insertEdge(parent, null, 'HTTP/REST', frontend, api, arrowStyle);
              graph.insertEdge(parent, null, 'SQL', api, database, arrowStyle);

              graph.fit();
              graph.center();

              return { success: true, components: 3, connections: 2 };
            } finally {
              model.endUpdate();
            }
          })()
        timeout: 1000
        returns: "{ success: true, components: 3, connections: 2 }"
        why: Use Draw.io's graph API to create a 3-tier architecture diagram.

  - id: verify_diagram
    description: Verify diagram was created
    depends: [create_diagram]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (function() {
            const ui = window.editorUi;
            if (!ui || !ui.editor || !ui.editor.graph) {
              return { error: 'Editor not ready' };
            }

            const graph = ui.editor.graph;
            const cells = graph.getChildCells(graph.getDefaultParent(), true, true);

            let vertices = 0, edges = 0;
            for (const cell of cells) {
              if (cell.vertex) vertices++;
              if (cell.edge) edges++;
            }

            return {
              verified: vertices >= 3 && edges >= 2,
              vertices,
              edges
            };
          })()
        timeout: 1000
        returns: "{ verified: true, vertices: 3, edges: 2 }"
        why: Verify the diagram contains the expected components and connections.

  - id: open_export_dialog
    description: Open Draw.io export dialog
    depends: [verify_diagram]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (function() {
            const ui = window.editorUi;
            if (!ui || !ui.actions) {
              throw new Error('Draw.io editor not found');
            }
            const action = ui.actions.get('exportPng');
            if (!action) {
              throw new Error('Action not found: exportPng');
            }
            action.funct();
            return { triggered: true };
          })()
        why: Trigger Draw.io's native export PNG action.

  - id: wait_for_export_dialog
    description: Wait for export options dialog
    depends: [open_export_dialog]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (async function() {
            const timeout = 10000;
            const interval = 200;
            const start = Date.now();
            while (Date.now() - start < timeout) {
              const dialogs = document.querySelectorAll('.geDialog');
              for (const d of dialogs) {
                if (d.textContent.includes('Zoom')) return { found: true };
              }
              await new Promise(r => setTimeout(r, interval));
            }
            throw new Error('Export dialog not found within timeout');
          })()
        timeout: 1000
        why: Wait for Draw.io's export options dialog (contains "Zoom" setting).

  - id: click_export_button
    description: Click Export in dialog
    depends: [wait_for_export_dialog]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (function() {
            const buttons = document.querySelectorAll('button');
            for (const btn of buttons) {
              if (btn.textContent && btn.textContent.includes('Export')) {
                btn.click();
                return { clicked: true };
              }
            }
            throw new Error('Export button not found');
          })()
        timeout: 5000
        why: Click the Export button to proceed to Save As dialog.

  - id: wait_for_save_dialog
    description: Wait for Save As dialog
    depends: [click_export_button]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (async function() {
            const timeout = 10000;
            const interval = 200;
            const start = Date.now();
            while (Date.now() - start < timeout) {
              const dialogs = document.querySelectorAll('.geDialog');
              for (const d of dialogs) {
                if (d.querySelector("input[type='text']")) return { found: true };
              }
              await new Promise(r => setTimeout(r, interval));
            }
            throw new Error('Save dialog not found within timeout');
          })()
        timeout: 1000
        why: Wait for Save As dialog with filename input.

  - id: select_downloads_destination
    description: Select Downloads from destination dropdown
    depends: [wait_for_save_dialog]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (function() {
            const dialogs = document.querySelectorAll('.geDialog');
            for (const d of dialogs) {
              const selects = d.querySelectorAll('select');
              for (const select of selects) {
                for (let i = 0; i < select.options.length; i++) {
                  const opt = select.options[i];
                  if (opt.text.toLowerCase().includes('download') ||
                      opt.value.toLowerCase().includes('download')) {
                    select.selectedIndex = i;
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                    return { selected: true, value: opt.value, text: opt.text };
                  }
                }
              }
            }
            return { selected: false, reason: 'Downloads option not found' };
          })()
        timeout: 1000
        why: Select Downloads from the destination dropdown.

  - id: get_export_data_and_save
    description: Get PNG data and save to file
    depends: [select_downloads_destination]
    steps:
      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) throw new Error('Webview not found');

          // Get filename and destination from dialog
          const dialogInfo = await webview.executeJavaScript(`
            (function() {
              const dialogs = document.querySelectorAll('.geDialog');
              for (const d of dialogs) {
                let filename = 'export.png';
                let destination = 'device';

                const inputs = d.querySelectorAll('input[type="text"]');
                for (const input of inputs) {
                  if (input.value && input.value.includes('.png')) {
                    filename = input.value;
                    break;
                  }
                }

                const selects = d.querySelectorAll('select');
                for (const select of selects) {
                  const val = select.value?.toLowerCase() || '';
                  const text = select.options?.[select.selectedIndex]?.text?.toLowerCase() || '';
                  if (val.includes('download') || text.includes('download')) {
                    destination = 'downloads';
                  }
                }

                if (filename) return { filename, destination };
              }
              return { filename: 'export.png', destination: 'device' };
            })()
          `);

          const filename = dialogInfo.filename || 'export.png';
          const destination = dialogInfo.destination || 'device';

          // Get PNG data from Draw.io
          const result = await webview.executeJavaScript(`
            new Promise((resolve, reject) => {
              const ui = window.editorUi;
              if (!ui || !ui.editor) {
                reject(new Error('Editor not available'));
                return;
              }
              ui.editor.exportToCanvas(
                (canvas) => resolve({ success: true, dataUrl: canvas.toDataURL('image/png') }),
                null, null, '#1e1e1e',
                (e) => reject(e),
                null, true, 1, false, false, null, null, 10, true
              );
            })
          `);

          if (!result.success || !result.dataUrl) {
            throw new Error('Failed to get export data');
          }

          // Close dialog
          await webview.executeJavaScript(`
            (function() {
              const dialogs = document.querySelectorAll('.geDialog');
              for (const d of dialogs) {
                const btn = Array.from(d.querySelectorAll('button')).find(b => b.textContent.trim() === 'Cancel');
                if (btn) { btn.click(); return; }
              }
            })()
          `);

          // Determine output path
          let outputDir = '/tmp';
          if (destination === 'downloads') {
            const downloadsResult = await window.cyrus.shell.getDownloadsDir();
            if (downloadsResult.success && downloadsResult.data) {
              outputDir = downloadsResult.data;
            }
          }

          const outputPath = outputDir + '/' + filename;
          const base64Data = result.dataUrl.replace('data:image/png;base64,', '');

          const writeResult = await window.cyrus.shell.writeFile({
            path: outputPath,
            data: base64Data,
            encoding: 'base64',
            source: 'test'
          });

          if (!writeResult.success) {
            throw new Error('Write failed: ' + (writeResult.error?.message || 'unknown'));
          }

          return {
            success: true,
            path: outputPath,
            filename,
            destination,
            size: writeResult.data?.size || 0
          };
        timeout: 1000
        returns: "{ success: true, path: '<destination>/<filename>.png' }"
        why: Export PNG data and write to file, bypassing OS save dialog.
