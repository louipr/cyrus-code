# Draw.io Export Native Dialog Flow
#
# Tests clicking Export in the dialog to see what happens with the native Save As.
# Uses screenshots at each step to understand the flow.

name: Export Native Dialog Flow
description: |
  Click through the full export flow including the Export button.
  Take screenshots to understand what happens at each step.

metadata:
  status: draft
  reliability: unknown
  tags: [export, png, drawio, native-dialog]
  author: AI exploration
  created: "2025-01-04"

context:
  app: cyrus-code
  prerequisites:
    - App is launched
  waitFor: "[data-testid='search-bar']"

tasks:
  - id: open-diagram
    name: Open diagram view
    steps:
      - action: click
        selector: "[data-testid='view-toggle'] button:has-text('Diagram')"
        why: Switch to diagram view.

      - action: wait-for
        selector: "[data-testid='diagram-webview']"
        timeout: 10000
        why: Wait for Draw.io webview.

  - id: wait-for-drawio
    name: Wait for Draw.io editor
    depends: [open-diagram]
    steps:
      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) throw new Error('Webview not found');

          for (let i = 0; i < 30; i++) {
            await new Promise(r => setTimeout(r, 500));
            try {
              const ready = await webview.executeJavaScript(`
                (function() {
                  const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
                  return !!(ui && ui.editor && ui.editor.graph);
                })()
              `);
              if (ready) return { ready: true, attempts: i + 1 };
            } catch (e) { }
          }
          throw new Error('Draw.io editor not ready');
        timeout: 20000
        why: Wait for Draw.io API.

  - id: wait-for-loading
    name: Wait for loading complete
    depends: [wait-for-drawio]
    steps:
      - action: evaluate
        code: |
          for (let i = 0; i < 50; i++) {
            await new Promise(r => setTimeout(r, 200));
            const loading = document.querySelector('[data-testid="diagram-loading"]');
            if (!loading) return { ready: true };
          }
          throw new Error('Loading did not complete');
        timeout: 15000
        why: Wait for loading indicator to disappear.

  - id: create-diagram
    name: Create test diagram
    depends: [wait-for-loading]
    steps:
      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) throw new Error('Webview not found');

          const result = await webview.executeJavaScript(`
            (function() {
              const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
              if (!ui || !ui.editor || !ui.editor.graph) return { error: 'Editor not ready' };

              const graph = ui.editor.graph;
              const model = graph.getModel();
              const parent = graph.getDefaultParent();

              model.beginUpdate();
              try {
                graph.removeCells(graph.getChildCells(parent, true, true));
                const style = 'rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontStyle=1;fontSize=14;';
                const arrowStyle = 'edgeStyle=orthogonalEdgeStyle;rounded=0;strokeWidth=2;';
                const box1 = graph.insertVertex(parent, null, 'Export Test', 100, 100, 140, 60, style);
                const box2 = graph.insertVertex(parent, null, 'PNG Output', 300, 100, 140, 60, style);
                graph.insertEdge(parent, null, 'generates', box1, box2, arrowStyle);
                graph.fit();
                return { success: true };
              } finally {
                model.endUpdate();
              }
            })()
          `);
          if (result.error) throw new Error(result.error);
          return result;
        timeout: 10000
        why: Create test diagram.

  - id: screenshot-before
    name: Screenshot before export
    depends: [create-diagram]
    steps:
      - action: screenshot
        returns: /tmp/native-export-01-diagram.png
        why: Screenshot of diagram before export.

  - id: open-export-dialog
    name: Open export dialog
    depends: [screenshot-before]
    steps:
      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) throw new Error('Webview not found');

          await webview.executeJavaScript(`
            (function() {
              const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
              if (ui.actions && ui.actions.get('exportPng')) {
                ui.actions.get('exportPng').funct();
                return { triggered: true };
              }
              throw new Error('exportPng action not available');
            })()
          `);
          return { triggered: true };
        timeout: 10000
        why: Trigger exportPng action.

      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          for (let i = 0; i < 30; i++) {
            await new Promise(r => setTimeout(r, 200));
            const hasDialog = await webview.executeJavaScript(`
              (function() {
                const dialogs = document.querySelectorAll('.geDialog');
                for (const d of dialogs) {
                  if (d.textContent.includes('Zoom') || d.textContent.includes('Border')) return true;
                }
                return false;
              })()
            `);
            if (hasDialog) return { dialogOpen: true, attempts: i + 1 };
          }
          throw new Error('Export dialog did not open');
        timeout: 10000
        why: Wait for export dialog.

  - id: screenshot-dialog
    name: Screenshot export dialog
    depends: [open-export-dialog]
    steps:
      - action: screenshot
        returns: /tmp/native-export-02-dialog.png
        why: Screenshot of export dialog options.

  - id: click-export
    name: Click Export button
    depends: [screenshot-dialog]
    steps:
      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) throw new Error('Webview not found');

          const clicked = await webview.executeJavaScript(`
            (function() {
              const dialogs = document.querySelectorAll('.geDialog');
              for (const dialog of dialogs) {
                const buttons = dialog.querySelectorAll('button');
                for (const btn of buttons) {
                  // Find Export button (not Cancel)
                  const text = btn.textContent.trim();
                  if (text === 'Export' || (text.includes('Export') && !text.includes('Cancel'))) {
                    btn.click();
                    return { clicked: true, buttonText: text };
                  }
                }
              }
              return { clicked: false, buttons: Array.from(document.querySelectorAll('.geDialog button')).map(b => b.textContent) };
            })()
          `);

          if (!clicked.clicked) throw new Error('Export button not found: ' + JSON.stringify(clicked));
          return clicked;
        timeout: 5000
        why: Click Export button to proceed.

  - id: wait-after-export
    name: Wait and observe
    depends: [click-export]
    steps:
      - action: evaluate
        code: |
          await new Promise(r => setTimeout(r, 1000));
          return { waited: true };
        timeout: 3000
        why: Brief wait after click.

      - action: screenshot
        returns: /tmp/native-export-03-after-click.png
        why: Screenshot immediately after clicking Export.

      - action: evaluate
        code: |
          await new Promise(r => setTimeout(r, 2000));
          return { waited: true };
        timeout: 5000
        why: Wait more.

      - action: screenshot
        returns: /tmp/native-export-04-after-wait.png
        why: Screenshot after waiting.

  - id: check-state
    name: Check current state
    depends: [wait-after-export]
    steps:
      - action: evaluate
        code: |
          const webview = document.querySelector('[data-testid="diagram-webview"]');
          if (!webview) return { webviewPresent: false };

          const state = await webview.executeJavaScript(`
            (function() {
              const dialogs = document.querySelectorAll('.geDialog');
              const dialogInfo = [];
              for (const d of dialogs) {
                dialogInfo.push({
                  text: d.textContent.substring(0, 300),
                  buttons: Array.from(d.querySelectorAll('button')).map(b => b.textContent)
                });
              }
              return {
                dialogCount: dialogs.length,
                dialogs: dialogInfo
              };
            })()
          `);
          return state;
        timeout: 5000
        why: Check what dialogs are present now.
