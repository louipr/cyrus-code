# Create C4 Context Diagram
#
# Opens Draw.io and creates a C4 Context diagram showing a software system
# with external actors and dependencies.
#
# @agent-context
# Context for LLM agents and developers working with Draw.io test suites.
#
# Access: '[data-testid="diagram-webview"]' via webview.executeJavaScript()
#
# Globals available in Draw.io context:
#   __cyrusEditorUi  - EditorUi instance captured by preload hook (drawio-preload.ts)
#   __cyrusHooked    - Boolean indicating hook was installed
#   editorUi         - Native Draw.io EditorUi (embed mode only)
#   App              - Draw.io application class
#
# Key selectors:
#   .geDiagramContainer  - Main diagram container
#   .geDialog            - Draw.io dialog boxes
#   .geMenubar           - Menu bar
#   .geItem              - Menu items
#   .mxPopupMenu         - Context menus
#
# Hook mechanism (see electron/preload/drawio-preload.ts):
#   The preload script wraps App.main() to intercept the EditorUi callback.
#   This provides access to:
#   - editorUi.editor.graph      - the mxGraph instance
#   - editorUi.editor.exportToCanvas() - native PNG export
#   - editorUi.actions           - menu action handlers

description: Create a C4 Context diagram with a central system, users, and external systems.

metadata:
  status: draft
  reliability: medium
  tags: [smoke, diagram, drawio, c4, architecture]
  author: smoke-test
  created: "2025-01-03"
  modified: "2025-01-14"

context:
  app: cyrus-code
  prerequisites:
    - App is launched
  waitFor: "[data-testid='search-bar']"

test_cases:
  - id: open_diagram
    description: Open diagram view
    steps:
      - action: click
        selector: "[data-testid='view-toggle'] button:has-text('Diagram')"
        why: Click the Diagram button to switch to diagram view.

      - action: poll
        selector: "[data-testid='diagram-webview']"
        timeout: 10000
        why: Wait for Draw.io webview to appear.

  - id: wait_for_drawio
    description: Wait for Draw.io editor
    depends: [open_diagram]
    steps:
      # Wait for Draw.io editor API using evaluate with retry loop
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (async function() {
            const timeout = 20000;
            const interval = 500;
            const start = Date.now();
            while (Date.now() - start < timeout) {
              const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
              if (ui && ui.editor && ui.editor.graph) {
                return { ready: true };
              }
              await new Promise(r => setTimeout(r, interval));
            }
            throw new Error('Draw.io editor not ready within timeout');
          })()
        timeout: 25000
        why: Wait for Draw.io's editor API to be available.

  - id: wait_for_editor_ready
    description: Wait for editor loading indicator to disappear
    depends: [wait_for_drawio]
    steps:
      # Assert loading indicator is gone (after editor is ready, it should be)
      - action: assert
        selector: "[data-testid='diagram-loading']"
        exists: false
        timeout: 15000
        why: Verify the React loading indicator has disappeared.

  - id: create_c4_diagram
    description: Create C4 Context diagram
    depends: [wait_for_editor_ready]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (function() {
            const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
            if (!ui || !ui.editor || !ui.editor.graph) {
              return { error: 'Editor not ready' };
            }

            const graph = ui.editor.graph;
            const model = graph.getModel();
            const parent = graph.getDefaultParent();

            model.beginUpdate();
            try {
              graph.removeCells(graph.getChildCells(parent, true, true));

              // C4 Styles
              const personStyle = 'shape=umlActor;verticalLabelPosition=bottom;verticalAlign=top;html=1;fillColor=#08427b;strokeColor=#073763;fontColor=#ffffff;fontSize=12;';
              const systemStyle = 'rounded=1;whiteSpace=wrap;html=1;fillColor=#1168bd;strokeColor=#0b4884;fontColor=#ffffff;fontStyle=1;fontSize=14;arcSize=10;';
              const externalStyle = 'rounded=1;whiteSpace=wrap;html=1;fillColor=#999999;strokeColor=#666666;fontColor=#ffffff;fontStyle=1;fontSize=14;arcSize=10;dashed=1;';
              const arrowStyle = 'edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;strokeWidth=2;strokeColor=#666666;dashed=1;';

              // Title
              const title = graph.insertVertex(parent, null, 'System Context Diagram\\ncyrus-code', 150, 10, 300, 50,
                'text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;fontStyle=1;fontSize=18;fontColor=#333333;');

              // Person: Developer
              const developer = graph.insertVertex(parent, null, 'Developer', 50, 150, 60, 100, personStyle);

              // Main System: cyrus-code
              const mainSystem = graph.insertVertex(parent, null, 'cyrus-code\\n\\n[Software System]\\n\\nComponent registry and\\narchitecture visualization', 180, 120, 200, 120, systemStyle);

              // External: Git Repository
              const gitRepo = graph.insertVertex(parent, null, 'Git Repository\\n\\n[External System]\\n\\nStores component\\ndefinitions', 450, 80, 160, 100, externalStyle);

              // External: AI Service
              const aiService = graph.insertVertex(parent, null, 'AI Service\\n\\n[External System]\\n\\nCode generation\\nand analysis', 450, 220, 160, 100, externalStyle);

              // Connections
              graph.insertEdge(parent, null, 'Uses', developer, mainSystem, arrowStyle);
              graph.insertEdge(parent, null, 'Reads/Writes', mainSystem, gitRepo, arrowStyle);
              graph.insertEdge(parent, null, 'Generates code via', mainSystem, aiService, arrowStyle);

              graph.fit();
              graph.center();

              return { success: true, elements: 5, connections: 3 };
            } finally {
              model.endUpdate();
            }
          })()
        timeout: 10000
        returns: "{ success: true, elements: 5, connections: 3 }"
        why: Create a C4 Context diagram showing cyrus-code with Developer, Git, and AI Service.

  - id: verify_c4
    description: Verify C4 diagram
    depends: [create_c4_diagram]
    steps:
      - action: evaluate
        webview: "[data-testid='diagram-webview']"
        code: |
          (function() {
            const ui = window.__cyrusEditorUi || window.editorUi || window.ui;
            if (!ui || !ui.editor || !ui.editor.graph) {
              return { error: 'Editor not ready' };
            }

            const graph = ui.editor.graph;
            const cells = graph.getChildCells(graph.getDefaultParent(), true, true);

            let vertices = 0, edges = 0;
            for (const cell of cells) {
              if (cell.vertex) vertices++;
              if (cell.edge) edges++;
            }

            return {
              verified: vertices >= 4 && edges >= 3,
              vertices,
              edges
            };
          })()
        timeout: 5000
        returns: "{ verified: true, vertices: 5, edges: 3 }"
        why: Verify the C4 diagram has the expected elements.
