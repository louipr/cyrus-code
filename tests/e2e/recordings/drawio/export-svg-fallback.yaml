# Draw.io SVG Fallback Export Recording
#
# Extracts the diagram as SVG when native PNG export isn't available.
# This is a fallback method that works even without EditorUi access.

name: Draw.io SVG Fallback Export
description: |
  Extract the diagram as SVG directly from the DOM.
  Use this when native exportToCanvas is unavailable.
  The SVG can be converted to PNG using sharp or similar library.

metadata:
  status: verified
  reliability: medium
  tags: [export, svg, drawio, fallback, dom-extraction]
  author: AI exploration session
  created: "2025-01-01"
  modified: "2025-01-01"

context:
  app: diagram-webview
  prerequisites:
    - Diagram view is active
    - A diagram is rendered (any source)
  waitFor: ".geDiagramContainer"

tasks:
  - id: extract-svg
    name: Extract SVG from diagram container
    steps:
      - action: wait-for
        selector: ".geDiagramContainer svg"
        timeout: 30000
        why: |
          Draw.io renders the diagram as an SVG element inside
          .geDiagramContainer. We wait for this to exist.

      - action: evaluate
        code: |
          (function() {
            var container = document.querySelector('.geDiagramContainer');
            if (!container) return { error: 'no container' };

            var svg = container.querySelector('svg');
            if (!svg) return { error: 'no svg' };

            // Get the bounding box to determine dimensions
            var bbox = svg.getBBox();
            var width = Math.ceil(bbox.width + bbox.x + 40);
            var height = Math.ceil(bbox.height + bbox.y + 40);

            // Clone the SVG to avoid modifying the original
            var svgClone = svg.cloneNode(true);
            svgClone.setAttribute('width', width);
            svgClone.setAttribute('height', height);
            svgClone.setAttribute('xmlns', 'http://www.w3.org/2000/svg');

            // Add dark background rectangle
            var rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
            rect.setAttribute('fill', '#1e1e1e');
            svgClone.insertBefore(rect, svgClone.firstChild);

            // Serialize to string
            var svgString = new XMLSerializer().serializeToString(svgClone);

            // Return as base64 data URL
            var base64 = btoa(unescape(encodeURIComponent(svgString)));

            return {
              success: true,
              dataUrl: 'data:image/svg+xml;base64,' + base64,
              width: width,
              height: height,
              size: svgString.length
            };
          })()
        why: |
          We extract the SVG directly from the DOM:
          1. Find the SVG element in .geDiagramContainer
          2. Clone it to avoid modifying the displayed diagram
          3. Set explicit width/height based on bounding box
          4. Add a dark background rectangle to match our theme
          5. Serialize to string and encode as base64

          The result is an SVG data URL that can be:
          - Decoded and saved as .svg file
          - Converted to PNG using sharp: sharp(svgBuffer).png()

  - id: extract-result
    name: Store SVG data URL
    depends: [extract-svg]
    steps:
      - action: evaluate
        code: |
          (function() {
            // The previous step already returned the data
            // This is just for consistency with the extract pattern
            return window.__lastEvalResult || null;
          })()
        why: Placeholder for result extraction pattern.

# Usage example:
#
# const result = await player.run('drawio/export-svg-fallback');
# const dataUrl = result.extracts['svg-data-url'];
# const base64 = dataUrl.replace(/^data:image\/svg\+xml;base64,/, '');
# const svgBuffer = Buffer.from(base64, 'base64');
#
# // Convert to PNG with sharp:
# const pngBuffer = await sharp(svgBuffer).png().toBuffer();
# fs.writeFileSync('output.png', pngBuffer);
